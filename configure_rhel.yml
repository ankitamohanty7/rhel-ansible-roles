---
- name: Configure RHEL
  hosts: all
  become: true
  gather_facts: false
  collections:
    - myllynen.rhel_ansible_roles
  vars:
    #
    # accounts_local
    #
    # List of local users to delete
    # NB. Will remove users' home dirs
    accounts_local_users_delete:
    #  - testuser

    # List of local groups to delete
    accounts_local_groups_delete:
    #  - testgroup

    # List of local groups to create
    # Mandatory parameters: name, gid
    accounts_local_groups_create:
    #  - name: testgroup
    #    gid: 12345

    # List of local users to create
    # Mandatory parameters: name, uid
    accounts_local_users_create:
    #  - name: testuser
    #    # This should come from vault
    #    password: ...
    #    uid: 12345
    #    group: testgroup
    #    comment: Test User
    #    home: /home/testuser
    #    shell: /bin/bash
    #    expires: -1

    # Use true if providing crypted values,
    # false to encrypt cleartext passwords.
    accounts_local_password_encrypted: false
    # Seed for password_hash salt value
    accounts_local_password_salt_seed: "{{ inventory_hostname }}"

    # List of supplementary groups for users
    # Mandatory parameters: name, groups, append
    accounts_local_users_groups:
    #  - name: testuser
    #    groups: tcpdump,wheel
    #    append: true

    #
    # accounts_policy
    #
    # Accounts, login, password, PAM policies and profiles
    # All parameters are optional, unset are left untouched


    # New user defaults file useradd template
    # Role provided alternatives:
    # * useradd_cis.j2         - CIS Level 2 - Server compliant config
    # * useradd_rhel.j2        - RHEL default config
    useradd_defaults_file:

    # Shadow configuration file login.defs template
    # Role provided alternatives:
    # * login.defs_cis.j2      - CIS Level 2 - Server compliant config
    # * login.defs_rhel.j2     - RHEL default config
    login_defs_config_file:

    # PAM login access control file access.conf template
    # Role provided alternatives:
    # * access.conf_rhel.j2    - RHEL default config (empty table)
    login_access_config_file:

    # PAM faillock configuration file faillock.conf template
    # Role provided alternatives:
    # * faillock_cis.conf      - CIS Level 2 - Server compliant config
    # * faillock_rhel.conf     - RHEL default config
    faillock_config_file:

    # PAM password history config file pwhistory.conf template
    # NB. This is supported only since RHEL 8.8 / RHEL 9.2
    # NB. This is currently not compatible with oscap(8)
    # Role provided alternatives:
    # * pwhistory.conf_cis.j2  - CIS Level 2 - Server compliant config
    # * pwhistory.conf_rhel.j2 - RHEL default config
    pwhistory_config_file:

    # PAM password quality config file pwquality.conf template
    # Role provided alternatives:
    # * pwquality.conf_cis.j2  - CIS Level 2 - Server compliant config
    # * pwquality.conf_rhel.j2 - RHEL default config
    pwquality_config_file:


    # Either use a system provided profile (e.g., "minimal")
    # or copy and use a custom one. A custom profile must be
    # named as "custom/name". E.g., use "/srv/custom/strict"
    # to copy the profile custom/strict from local path /srv
    # Role provided alternatives:
    # * custom/cis  -  CIS Level 2 - Server compliant profile
    #                  incl. optional support for Centrify.
    system_auth_profile:

    # Profile parameters for "authselect select" command
    # See the "authselect show 'profile'" output for details
    # E.g., with "minimal" use without-nullok with-pamaccess
    # With "custom/cis" the following parameters can be used:
    #   with-centrify with-mkhomedir with-pamaccess
    system_auth_profile_parameters:

    # Optional PAM su configuration file template
    # Role provides CIS-compliant pam_d_su.j2 which enables
    # Centrify support automatically if using with-centrify
    system_auth_pam_d_su_file:

    #
    # aide_setup
    #
    # aide config file to copy, if defined
    aide_setup_config_file:

    # Initialize aide database if not present
    aide_setup_initialize_database: true

    # Enable daily aide check using cron
    aide_setup_cron_setup: true

    #
    # audit_setup
    #
    # Optional auditd config file to copy
    # If unset default RHEL configuration will be used
    audit_setup_config_file:

    # Optional audit rules file to copy
    audit_setup_rules_file:

    # Action with locked rules if rules changed
    # Allowed values: fail, ignore, reboot
    audit_setup_update_lock: fail

    #
    # boot_parameters
    #
    boot_parameters_enable:
      - quiet

    boot_parameters_disable:
      - debug
      - rhgb

    boot_parameters_timeout: 1

    # Protect boot parameters with password
    # NB. For the time being this should be
    # PBKDF2 hash to allow idempotency, use
    # grub2-mkpasswd-pbkdf2(3) to create one
    # Boot loader username is always 'root'
    # This should come from vault. If unset
    # current configuration is not touched,
    # setting to empty will remove password
    #boot_parameters_password:

    # Reboot system after parameter changes
    boot_parameters_reboot: true

    #
    # certificates
    #
    # List of CA bundle files in PEM format
    certificates_ca_files:
    #  - local-ca-bundle.pem

    # Copy CA certs also to /etc/pki/tls/cert
    certificates_copy_certs: false

    #
    # dns_cache
    #
    # Enable or disable DNS cache
    dns_cache_enable: true

    # DNS caching component (dnsmasq recommended)
    # Allowed values: dnsmasq, nscd, systemd-resolved
    # See https://access.redhat.com/solutions/2189381
    dns_cache_component: dnsmasq

    # Minimum cache/local/negative TTL value for dnsmasq
    # to use in case none is provided in upstream reply
    dns_cache_dnsmasq_ttl: 10

    # NetworkManager dnsmasq configuration template
    # to use instead of the role provided default one
    dns_cache_nm_dnsmasq_config_file:

    #
    # domain_ad
    #
    # Allowed actions: join, leave
    domain_ad_action: join
    domain_ad_domain: example.com

    # These should come from vault
    #domain_ad_admin_username:
    #domain_ad_admin_password:

    domain_ad_computer_precreated: false
    domain_ad_computer_delete_on_leave: true

    #domain_ad_allow_groups: GROUP@example.com

    # Enable or disable running authconfig/authselect
    # If false then setup by this role is not complete
    domain_ad_auth_config_update: true

    # Extra parameters for "authselect select" command
    # See the "authselect show sssd" output for details
    domain_ad_auth_select_parameters: without-nullok with-pamaccess with-mkhomedir

    # krb5.conf and sssd.conf template files to use
    # if not using the role provided default files
    domain_ad_krb5_config_file:
    domain_ad_sssd_config_file:

    #
    # etc_hosts
    #
    # /etc/hosts header to always apply (subject to etc_hosts_omit_hosts)
    # This default header matches the most recent Fedora/upstream headers
    etc_hosts_header: |
      # Loopback entries; do not change.
      # For historical reasons, localhost precedes localhost.localdomain:
      127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
      ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

    # Add entry for host itself based on Ansible facts
    # This should be disabled when not using static IP
    etc_hosts_self_add: true

    # Force domain name used in host self entry
    # If unset defaults to ansible_facts.domain
    # Required if ansible_facts.domain is empty
    etc_hosts_self_domain:

    # List of lines to add to /etc/hosts
    # NB. Other entries will be removed
    etc_hosts_entries:
    #  - 192.168.122.1    gateway.example.com gateway
    #  - 192.168.122.150  bastion.example.com bastion

    # /etc/hosts entries to omit
    # none - do not omit entries
    # ipv4 - omit all IPv4 entries
    # ipv6 - omit all IPv6 entries
    etc_hosts_omit_hosts: none

    #
    # fapolicyd_setup
    #
    # Enable or disable service after configuration
    # to allow testing and verification before use.
    # NB. See ima_evm_setup if planning to use IMA.
    fapolicyd_setup_enable_service: false

    # fapolicyd config file to copy, role default ~ RHEL default
    fapolicyd_setup_config_file: fapolicyd.conf

    # fapolicyd rules file to copy, rules default ~ RHEL default
    fapolicyd_setup_rules_file: fapolicyd.rules

    # fapolicyd trust file to copy, trust default is empty file
    fapolicyd_setup_trust_file: fapolicyd.trust

    #
    # files_{copy,create,fetch,get,remove} - omitted here for brevity
    #

    #
    # fips_setup
    #
    # NB! It is best to enable FIPS mode during OS
    # installation in order to ensure all keys are
    # being generated with FIPS-compliant algorithms.

    # Enable & check or not FIPS mode
    # Disabling FIPS mode is unsupported
    fips_setup_enable: true

    #
    # firewall
    #
    firewall_enable: true

    firewall_default_zone: public

    # List of ports (80/tcp, 123/udp, ...) or services (cockpit, https, ...)
    # vars/main.yml lists always open ports/services. ssh is always kept open.
    firewall_open_ports:
    #  - 321/udp

    firewall_open_services:
    #  - samba

    # Close unconfigured ports and services
    firewall_close_unconfigured: true

    #
    # insights_client
    #
    # Register or unregister the system for Red Hat Insights
    # See https://access.redhat.com/products/red-hat-insights
    insights_client_register: true

    # Optional tag/value pairs to apply for the system
    insights_client_tags:
    #  group: prod
    #  security: strict
    #  network_performance: latency

    # Enable Red Hat connector (rhc) when needed
    # See https://access.redhat.com/articles/rhc
    insights_client_rhc_enable: true

    # Install OpenSCAP packages to allow compliance scanning
    # See https://access.redhat.com/articles/4602981
    insights_client_scap_enable: true

    # Proxy server to use with insights-client
    insights_client_proxy_server:

    #
    # ipv6_setup
    #
    # Enable or disable IPv6 using sysctl settings
    # Boot parameter to disable IPv6 will be removed
    # See https://access.redhat.com/solutions/8709
    ipv6_setup_enable: true

    # Some applications (e.g., Samba) require IPv6 stack
    # to be enabled to function but need no IPv6 routing
    # This option keeps IPv6 on for the loopback device
    # This option has effect only when disabling IPv6
    ipv6_setup_loopback_persist: false

    # Either use system-roles.network to configure
    # NetworkManager or allow this role to update NM
    ipv6_setup_configure_nm: true

    #
    # motd_issue
    #
    # motd template to use
    motd_template:

    # issue template to use
    issue_template:

    #
    # multipath_setup
    #
    # Multipath config file to copy
    multipath_setup_config_file:

    # Reboot system after changes
    # multipathd will be restarted if no reboot
    multipath_setup_reboot: true

    #
    # packages_install - default list omitted here for brevity
    #
    #packages_install:
    #  -

    # Enable or disable yum module 'install_weak_deps' parameter
    packages_install_weak_deps: true

    #
    # packages_remove - default list omitted here for brevity
    #
    #packages_remove:
    #  -

    # Enable or disable yum module 'autoremove' parameter
    # to remove all "leaf" packages no longer required
    packages_remove_autoremove: true

    #
    # performance_tuning
    #
    tuned_profile: "{{ 'virtual-guest' if ansible_facts.virtualization_role == 'guest' else 'throughput-performance' }}"

    #
    # rescue_image
    #
    # Enable or disable rescue image
    # NB. Rescue images will be created on next kernel install
    rescue_image_enable: false

    #
    # repository_setup - config omitted here for brevity
    #

    #
    # resolver_configuration
    #
    # NetworkManager updates /etc/resolv.conf
    # true - use NM and system-roles.network
    # false - for using below configurations
    resolver_use_nm: true

    resolver_nameservers:
      - 1.1.1.1
      - 8.8.8.8

    resolver_search_domains:
    #  - corp.local
    #  - example.com

    resolver_options:
    #  - ends0
    #  - rotate
    #  - no-aaaa
    #  - timeout:1
    #  - attempts:1

    #
    # root_password
    #
    # Use true if providing crypted value,
    # false to encrypt cleartext password.
    root_password_encrypted: false
    # Seed for password_hash salt value
    root_password_salt_seed: "{{ inventory_hostname }}"
    # This should come from vault
    #root_password:

    #
    # scap_compliance
    #
    # RHEL provided OpenSCAP security profile
    # to apply and / or check for compliance.
    # Switching from one security profile to
    # another may not work and is unsupported
    scap_compliance_profile: cis_server_l1

    # Optional local tailoring file to use
    scap_compliance_tailoring_file_path:

    # Optional custom tailoring template to use
    # Needs scap_compliance_tailoring_file_path
    scap_compliance_tailoring_file_template:

    # State of OpenSCAP packages on the target
    # Allowed states: present, latest
    scap_compliance_package_state: present

    # Where to store oscap tool execution results
    # NB. Only the most recent results are stored
    scap_compliance_report_dir: /root/oscap/results

    # Remediate compliance issues
    # Warning: Reverting changes is not supported
    scap_compliance_remediate: false

    # Reboot system if remediation changed anything
    scap_compliance_remediate_reboot: true

    # Display complete results of compliance check
    # Failed check items will always be displayed
    scap_compliance_check_result_show_all: false

    # Allow role complete even if compliance check fails
    scap_compliance_check_fail_role_pass: false

    #
    # security_hardening
    #
    # Verify Secure Boot is enabled
    # Must be enabled on hardware level
    secure_boot_verify: false

    # One of: disabled, integrity, confidentiality
    # NB. Enabling lockdown will prevent using kdump
    kernel_lockdown: disabled

    selinux: enforcing

    crypto_policy: DEFAULT

    #
    # service_state
    #
    # List of services to stop and disable
    # Missing services will be ignored
    service_state_disable:
      - mlocate-updatedb.timer
      - nfs-client.target
      - rpcbind.service
      - rpcbind.socket

    # List of services to enable and start
    # Missing services will be ignored
    service_state_enable:
      - irqbalance.service

    #
    # shell_profile
    #
    # Shell profile template to use
    shell_profile_file: local.sh.j2

    #
    # splunk_forwarder
    #
    splunk_deployment_server: splunk.example.com
    splunk_deployment_server_port: 8089
    splunk_deployment_server_check: true

    splunk_user_uid: 4445
    # This should come from vault
    #splunk_user_password_hash:

    splunk_phonehome_secs: 600

    # Allowed states: present, latest
    splunk_forwarder_package_state: present

    # Deployment and user configuration templates
    # to use if not using the role provided defaults
    splunk_deployment_config_file:
    splunk_user_config_file:

    #
    # sshd_configuration
    #
    # These options will be enabled/updated in config
    sshd_options:
      PermitRootLogin: prohibit-password
      X11Forwarding: "no"

    # These options will be commented out from config
    sshd_options_disable:
      - Banner

    #
    # system_coredump
    #
    # Enable or disable system-wide coredumps
    system_coredump_enable: true

    #
    # system_hostname
    #
    # System hostname to be configured in /etc/hostname
    #
    # Should be short name (not FQDN) when using DHCP,
    # FQDN might be better option when using static IP
    # but some software will require using short names
    # Note that maximum allowed length is 63 characters
    system_hostname: "{{ ansible_facts.fqdn | lower }}"

    #
    # system_init
    #
    # Actions to take after initialization
    # reboot - reboot after initialization
    # syslog - write message to system log
    system_init_final_actions:
      - reboot
      - syslog

    #
    # system_keyboard
    #
    system_keyboard: us
    system_font: eurlatgr

    #
    # system_locale
    #
    # Available locale choices:
    # C.UTF-8 - properly supported on RHEL 9+
    # en_US.UTF-8 - supported on all RHEL versions
    # auto - use C.UTF-8 if RHEL 9+ else en_US.UTF-8
    system_locale: auto

    # Reboot system after changes
    system_locale_reboot: true

    #
    # system_reboot
    #
    # Reboot policy
    # never - never reboot
    # when_needed - reboot if needs-restarting says so
    # always - always reboot
    system_reboot_policy: when_needed

    #
    # system_unregister
    #
    # This role unconditionally unregisters a RHEL system from
    # both Red Hat Insights and Red Hat Subscription Management

    #
    # system_update
    #
    # Reboot policy after applying updates
    # never - never reboot even if updates would require reboot
    # when_needed - reboot only when needed (using needs-restarting)
    # when_updated - reboot if updates were installed
    # always - always reboot even if no updates were installed
    system_update_reboot_policy: when_needed

    # Set true to send a report after updating packages
    system_update_report: true

    # Default recipient email address for the report if no
    # host-specific variable 'email' set in the inventory.
    system_update_report_default_recipient: root@localhost

    # Attach PDF version of the report
    # PDFs will be generated on the control host using
    # utilities from enscript and ghostscript packages
    system_update_report_pdf: false

    # Directory used to generate PDF files
    system_update_report_pdf_dir: /tmp/.ansible.pdf

    # Preamble text to include in all generated PDFs
    # <HOST> will be replaced with inventory hostname
    # <OSREL> will be replaced with OS release name
    # <DATE> will be replaced with patching date/time
    # <REBOOT> will be indicate reboot, true or false
    system_update_report_pdf_preamble: |
        System Update Report
        
        
        Server: <HOST>
        Patch date: <DATE>
        OS version: <OSREL>
        Server rebooted: <REBOOT>
        
        
        The following packages were updated:

    #
    # system_update_report_pre
    #
    # Default recipient email address for the report if no
    # host-specific variable 'email' set in the inventory.
    system_update_report_pre_default_recipient: root@localhost

    # Attach PDF version of the report
    # PDFs will be generated on the control host using
    # utilities from enscript and ghostscript packages
    system_update_report_pre_pdf: false

    # Directory used to generate PDF files
    system_update_report_pre_pdf_dir: /tmp/.ansible.pdf

    # Preamble text to include in all generated PDFs
    # <HOST> will be replaced with inventory hostname
    # <OSREL> will be replaced with OS release name
    system_update_report_pre_pdf_preamble: |
        Pending System Update Report
        
        
        Server: <HOST>
        OS version: <OSREL>
        
        
        The following package updates are pending:

    #
    # timesync
    #
    ntp_servers:
      - 0.rhel.pool.ntp.org
      - 1.rhel.pool.ntp.org
      - 2.rhel.pool.ntp.org
      - 3.rhel.pool.ntp.org
      - time.cloudflare.com

    #
    # timezone
    #
    timezone: UTC

    #
    # troubleshooting_tools - default list omitted here for brevity
    #
    #troubleshooting_tools:
    #  -

    # Enable PCP performance metrics as needed
    troubleshooting_tools_enable_perf_metrics: true

    #
    # usbguard_setup
    #
    # Policy to apply to USB devices
    # reject - block and reject all devices
    # custom - custom configuration, see below
    # allow - disable USBGuard and allow all USB devices
    usbguard_setup_policy: reject

    # Custom USBGuard configuration file
    # If unset default RHEL configuration will be used
    usbguard_setup_config_file:

    # Custom USBGuard rules file template to use
    usbguard_setup_rules_file:

    # To completely disable the USB subsystem
    # use the usbcore.nousb boot parameter,
    # also see usbcore.authorized_default.

    #
    # watchdog
    #
    watchdog_enable: true

    # Configure systemd watchdog options,
    # see systemd-system.conf(5) for info
    watchdog_runtime_sec: '60s'
    watchdog_reboot_sec: #'10min'
    watchdog_kexec_sec: #'off'
    watchdog_device: #/dev/watchdog0

    #
    # web_console
    #
    web_console_enable_perf_metrics: true

  roles:
    #- system_hostname
    - etc_hosts
    - resolver_configuration
    - ipv6_setup
    #- repository_setup
    #- rhel-system-roles.network
    #- rescue_image
    #- timezone
    - timesync
    - packages_remove
    - boot_parameters
    #- system_keyboard
    - system_locale
    - audit_setup
    #- { role: multipath_setup, when: ansible_facts.virtualization_role != 'guest' }
    #- rhel-system-roles.kernel_settings
    #- rhel-system-roles.storage
    #- rhel-system-roles.kdump
    #- system_update_report_pre
    #- system_update
    #- aide_setup
    #- accounts_policy
    #- accounts_local
    - certificates
    #- dns_cache
    #- { role: domain_ad, when: domain_ad_admin_username is defined }
    #- { role: ipaclient, state: present, when: ipaclient_domain is defined }
    ##- ima_evm_setup
    #- fapolicyd_setup
    #- fips_setup
    - firewall
    - watchdog
    #- motd_issue
    - packages_install
    - performance_tuning
    - root_password
    - security_hardening
    - service_state
    #- shell_profile
    - sshd_configuration
    #- troubleshooting_tools
    #- usbguard_setup
    #- web_console
    #- rhel-system-roles.logging
    #- rhel-system-roles.metrics
    #- splunk_forwarder
    #- system_coredump
    - system_init
    #- scap_compliance
    #- insights_client
    #- system_reboot
