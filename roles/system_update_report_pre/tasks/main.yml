---
- name: Check available package updates
  yum:
    name: '*'
    state: latest
    update_cache: true
  check_mode: true
  register: package_install
  changed_when: false

- name: Set list of available package updates (RHEL 7)
  set_fact:
    package_updates: "{{ package_install.changes | dict2items | join('\n') }}"
  when: ansible_facts.pkg_mgr == 'yum' and package_install.changes is defined

- name: Set list of available package updates
  set_fact:
    package_updates: "{{ package_install.results | join('\n') }}"
  when: ansible_facts.pkg_mgr == 'dnf' and 'Nothing to do' not in package_install.msg

- name: Display list of available package updates
  debug:
    var: package_updates
  when: package_updates is defined

- name: Notify about upcoming package updates
  script: send-notification '{{ hostvars[item].email | default(system_update_report_pre_default_recipient, true) }}' '{{ item }}' '{{ hostvars[item].package_updates }}'
  register: command_output
  delegate_to: localhost
  run_once: true
  become: false
  loop: "{{ ansible_play_batch }}"
  when: hostvars[item].package_updates is defined

- name: Display notification command debug output
  debug:
    msg: "{{ command_output.results | selectattr('item', 'equalto', inventory_hostname) | map(attribute='stdout') | first }}"
  when: hostvars[inventory_hostname].package_updates is defined
