---
- name: Install fapolicyd packages
  yum:
    name:
      - fapolicyd
      - fapolicyd-selinux
    state: present

- name: Check rules.d directory
  stat:
    path: /etc/fapolicyd/rules.d
  register: rules_dir

- name: Copy fapolicyd configuration file
  copy:
    src: "{{ fapolicyd_setup_config_file }}"
    dest: /etc/fapolicyd/fapolicyd.conf
    owner: root
    group: fapolicyd
    mode: '0644'
  register: daemon_config

- name: Copy fapolicyd rules file
  vars:
    rules_file: "{{ 'fapolicyd.rules' if not rules_dir.stat.exists else 'rules.d/zz-local.rules' }}"
  copy:
    src: "{{ fapolicyd_setup_rules_file }}"
    dest: /etc/fapolicyd/{{ rules_file }}
    owner: root
    group: fapolicyd
    mode: '0644'
  register: rules_config

- name: Remove old fapolicyd rules file
  file:
    path: /etc/fapolicyd/fapolicyd.rules
    state: absent
  when: rules_dir.stat.exists

- name: Copy fapolicyd trust file
  vars:
    trust_file: "{{ 'fapolicyd.trust' if not rules_dir.stat.exists else 'trust.d/zz-local.trust' }}"
  copy:
    src: "{{ fapolicyd_setup_trust_file }}"
    dest: /etc/fapolicyd/{{ trust_file }}
    owner: root
    group: fapolicyd
    mode: '0644'
  register: trust_config

- name: Verify fapolicyd configuration
  command: fapolicyd-cli --check-config
  changed_when: false
  when: rules_dir.stat.exists

- name: Enable fapolicyd service
  service:
    name: fapolicyd
    enabled: true
  when: fapolicyd_setup_enable_service | bool

- name: Start fapolicyd service
  service:
    name: fapolicyd
    state: started
  register: service_start
  when: fapolicyd_setup_enable_service | bool

- name: Apply fapolicyd configuration changes
  service:
    name: fapolicyd
    state: restarted
  when:
    - fapolicyd_setup_enable_service | bool
    - service_start is not changed
    - daemon_config is changed or
      rules_config is changed or
      trust_config is changed
