---
- name: Configure default coredump limit
  lineinfile:
    path: /etc/systemd/system.conf
    regexp: '(#|)DefaultLimitCORE=.*'
    line: 'DefaultLimitCORE=infinity'
  register: core_config

- name: Enable default coredump limit
  systemd:
    daemon_reload: true
  when: core_config is changed

- name: Allow safe suid binary coredumps
  sysctl:
    name: fs.suid_dumpable
    value: '2'
    sysctl_file: /etc/sysctl.d/50-coredump.conf
    sysctl_set: true

- name: Set list of abrt packages to install
  set_fact:
    abrt_packages_install: "{{ abrt_packages_install | default([]) + [item] }}"
  loop:
    - abrt
    - abrt-addon-ccpp
    - abrt-addon-vmcore
    - "{{ 'abrt-cli-ng' if ansible_facts.distribution_major_version|int >= 8 else 'abrt-cli' }}"
    - "{{ 'abrt-console-notification' if abrt_setup_enable_console_notification|bool else '' }}"
    - "{{ 'abrt-java-connector' if abrt_setup_enable_java_connector|bool else '' }}"
    - "{{ 'abrt-plugin-sosreport' if abrt_setup_enable_sosreport_plugin|bool and ansible_facts.distribution_major_version|int >= 8 else '' }}"

- name: Install abrt packages
  yum:
    name: "{{ abrt_packages_install | select() | list }}"
    state: present

- name: Set list of abrt packages to remove
  set_fact:
    abrt_packages_remove: "{{ abrt_packages_remove | default([]) + [item] }}"
  loop:
    - "{{ 'abrt-console-notification' if not abrt_setup_enable_console_notification|bool else '' }}"
    - "{{ 'abrt-java-connector' if not abrt_setup_enable_java_connector|bool else '' }}"
    - "{{ 'abrt-plugin-sosreport' if not abrt_setup_enable_sosreport_plugin|bool else '' }}"

- name: Remove abrt packages
  yum:
    name: "{{ abrt_packages_remove | select() | list }}"
    state: absent
    autoremove: true

- name: Configure abrt (GPG check)
  vars:
    gpg_check: "{{ 'yes' if abrt_setup_enable_unsigned_reports|bool else 'no' }}"
  lineinfile:
    path: /etc/abrt/abrt-action-save-package-data.conf
    regexp: '^OpenGPGCheck = .*'
    line: 'OpenGPGCheck = {{ gpg_check }}'
  register: gpg_config

- name: Configure abrt (oops plugin)
  vars:
    fatal_mce: "{{ 'yes' if abrt_setup_report_fatal_mce_only|bool else 'no' }}"
  lineinfile:
    path: /etc/abrt/plugins/oops.conf
    regexp: '^OnlyFatalMCE = .*'
    line: 'OnlyFatalMCE = {{ fatal_mce }}'
  register: mce_config

- name: Configure abrt (vmcore plugin)
  vars:
    copy_core: "{{ 'yes' if abrt_setup_enable_vmcore_spooling|bool else 'no' }}"
  lineinfile:
    path: /etc/abrt/plugins/vmcore.conf
    regexp: '^CopyVMcore = .*'
    line: 'CopyVMcore = {{ copy_core }}'
  register: vmcore_config

- name: Set list of abrt services to enable/disable
  set_fact:
    abrt_services: "{{ abrt_services | default([]) + [item] }}"
  loop:
    - { 'name': 'abrtd', 'enabled': true, 'state': 'started' }
    - { 'name': 'abrt-ccpp', 'enabled': true, 'state': 'started' }
    - { 'name': 'abrt-oops', 'enabled': true, 'state': 'started' }
    - "{{ { 'name': 'abrt-journal-core', 'enabled': false } if ansible_facts.distribution_major_version|int >= 8 else '' }}"
    - "{{ { 'name': 'abrt-xorg', 'enabled': false } if abrt_setup_enable_console_notification|bool else '' }}"

- name: Configure abrt services
  service:
    name: "{{ item.name }}"
    enabled: "{{ item.enabled }}"
    state: "{{ item.state | default(omit) }}"
  register: service_start
  loop: "{{ abrt_services | select() | list }}"

- name: Apply abrtd configuration changes
  service:
    name: abrtd
    state: restarted
  when:
    - service_start.results[0] is not changed
    - (gpg_config is changed or mce_config is changed or vmcore_config is changed)
