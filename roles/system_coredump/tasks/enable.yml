---
- name: Configure default coredump limit
  lineinfile:
    path: /etc/systemd/system.conf
    regexp: '(#|)DefaultLimitCORE=.*'
    line: 'DefaultLimitCORE=infinity'
  register: core_config

- name: Apply coredump limit change
  systemd:
    daemon_reload: true
  when: core_config is changed

- name: Allow safe suid binary coredumps
  sysctl:
    name: fs.suid_dumpable
    value: '2'
    sysctl_file: /etc/sysctl.d/50-coredump.conf
    sysctl_set: true
